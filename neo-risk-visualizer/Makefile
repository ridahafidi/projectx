# Makefile for NEO Risk Visualizer - NASA Space Apps Challenge 2025
.PHONY: help setup demo build up down logs clean test dev prod status health check-deps

# Default target
help: ## Show this help message
	@echo "ğŸ›¡ï¸  NEO Risk Visualizer - Docker Commands"
	@echo "========================================"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Quick Start: make demo"

# Environment Setup
check-deps: ## Check Docker dependencies
	@echo "ğŸ“‹ Checking Docker requirements..."
	@command -v docker >/dev/null 2>&1 || (echo "âŒ Docker not found. Please install Docker first." && exit 1)
	@docker compose version >/dev/null 2>&1 || (echo "âŒ Docker Compose not found. Please install Docker Compose first." && exit 1)
	@echo "âœ… Docker and Docker Compose found"

setup: check-deps ## Setup environment files
	@echo "ğŸ”§ Setting up environment..."
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Created .env file from template"; \
	else \
		echo "âœ… .env file already exists"; \
	fi

demo: setup ## Full demo - setup, build, and start with health checks
	@echo "ğŸš€ NEO Risk Visualizer - Full Demo"
	@echo "=================================="
	@echo ""
	$(MAKE) down
	@echo ""
	@echo "ğŸ—ï¸  Building Docker containers..."
	docker compose build
	@echo ""
	@echo "ğŸš€ Starting services..."
	docker compose up -d
	@echo ""
	@echo "â³ Waiting for services to be ready..."
	@sleep 10
	$(MAKE) health
	@echo ""
	@echo "âœ… Demo completed! Services are running:"
	@echo "   ğŸŒ Frontend: http://localhost:5173"
	@echo "   ğŸ“¡ Backend API: http://localhost:8000"
	@echo "   ğŸ“– API Docs: http://localhost:8000/docs"

# Development Environment
dev: ## Start development environment with hot-reload
	@echo "ğŸš€ Starting development environment..."
	docker compose up --build

dev-detached: ## Start development environment in background
	@echo "ğŸš€ Starting development environment (detached)..."
	docker compose up -d --build

# Production Environment
prod: ## Start production environment
	@echo "ğŸŒ Starting production environment..."
	docker compose -f docker-compose.prod.yml up -d --build

# Container Management
build: ## Build all containers
	@echo "ğŸ”¨ Building containers..."
	docker compose build

up: ## Start containers (without building)
	@echo "â¬†ï¸  Starting containers..."
	docker compose up -d

down: ## Stop and remove containers
	@echo "â¬‡ï¸  Stopping containers..."
	docker compose down

restart: ## Restart all services
	@echo "ğŸ”„ Restarting services..."
	docker compose restart

# Logs and Monitoring
logs: ## View logs from all services
	docker compose logs -f

logs-backend: ## View backend logs only
	docker compose logs -f backend

logs-frontend: ## View frontend logs only
	docker compose logs -f frontend

# Status and Health Checks
status: ## Show container status
	@echo "ğŸ“Š Container Status:"
	@docker compose ps

health: ## Check service health
	@echo "ğŸ¥ Checking service health..."
	@echo -n "Backend (API): "
	@curl -s http://localhost:8000/health >/dev/null 2>&1 && echo "âœ… Healthy" || echo "âŒ Not responding"
	@echo -n "Frontend: "
	@curl -s http://localhost:5173 >/dev/null 2>&1 && echo "âœ… Healthy" || echo "âŒ Not responding"

test-api: ## Test API endpoints
	@echo "ğŸ§ª Testing API endpoints..."
	@echo "Health check:"
	@curl -s http://localhost:8000/health | grep -q "healthy" && echo "âœ… Health endpoint working" || echo "âŒ Health endpoint failed"
	@echo "Root endpoint:"
	@curl -s http://localhost:8000/ | grep -q "Impactor" && echo "âœ… Root endpoint working" || echo "âŒ Root endpoint failed"

# Development Tools
shell-backend: ## Open shell in backend container
	docker compose exec backend bash

shell-frontend: ## Open shell in frontend container
	docker compose exec frontend sh

# Testing
test: ## Run all tests
	@echo "ğŸ§ª Running tests..."
	docker compose exec backend python -m pytest tests/ || echo "âš ï¸  Backend tests not configured"
	docker compose exec frontend npm run test || echo "âš ï¸  Frontend tests not configured"

test-backend: ## Run backend tests only
	docker compose exec backend python -m pytest tests/ -v || echo "âš ï¸  Backend tests not configured"

test-frontend: ## Run frontend tests only
	docker compose exec frontend npm run test || echo "âš ï¸  Frontend tests not configured"

# Maintenance
clean: ## Clean up containers, images, and volumes
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker compose down -v
	docker system prune -f
	docker volume prune -f

clean-all: ## Clean everything including images
	@echo "ğŸ§¹ Deep cleaning Docker resources..."
	docker compose down -v --rmi all
	docker system prune -af
	docker volume prune -f

# Quick Commands
quick-start: ## Quick start for demos (build + run detached)
	@echo "âš¡ Quick starting NEO Risk Visualizer..."
	docker compose up -d --build
	@sleep 5
	@echo "âœ… Services starting..."
	@echo "ğŸŒ Frontend: http://localhost:5173"
	@echo "ğŸ“¡ Backend: http://localhost:8000"